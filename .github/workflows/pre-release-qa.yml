name: V3 Legacy - Pre Release SDK Integration Tests

# This workflow tests the V3 Legacy SDK (Objective-C) integration
# For V4 Swift SDK tests, see verify.yml

on:
  push:
    paths:
      - 'v3-legacy/**'
  pull_request:
    paths:
      - 'v3-legacy/**'
  workflow_dispatch:

jobs:
  verify-cocoapods-iOS:
    runs-on: macos-15
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: Install pod, build project and run tests
        run: |
            echo "branch=${{ github.ref }}" >> $GITHUB_OUTPUT
            cd v3-legacy
            ./scripts/getSimulator
            DESTINATION="platform=iOS Simulator,name=$(cat ./iphoneSim),OS=latest"
            cd SDKIntegrationTestApps/iOSReleaseTest-Cocoapods/
            pod install
            xcodebuild test -scheme iOSReleaseTest -workspace iOSReleaseTest.xcworkspace -destination "$DESTINATION" | xcpretty && exit ${PIPESTATUS[0]}
  verify-carthage-iOS:
    runs-on: macos-15
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: Skip Carthage test (repo restructuring)
        run: |
            # V3 Legacy Carthage test is skipped due to repo restructuring
            # The root Package.swift (V4 SDK) conflicts with Carthage builds for V3 Legacy
            # V3 Legacy users should use CocoaPods, SPM (v3-legacy/Package.swift), or tagged releases
            echo "Skipping V3 Legacy Carthage iOS test - repo restructuring broke Carthage compatibility"
            echo "V3 Legacy SDK is still available via: CocoaPods, SPM, Manual xcframework, or tagged releases"
  verify-SPM-iOS:
    runs-on: macos-15
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: build project and run tests
        run: |
            cd v3-legacy
            ./scripts/getSimulator
            DESTINATION="platform=iOS Simulator,name=$(cat ./iphoneSim),OS=latest"
            cd SDKIntegrationTestApps/iOSReleaseTest-SPM/
            xcodebuild test -scheme iOSReleaseTest -project iOSReleaseTest.xcodeproj -destination "$DESTINATION" | xcpretty && exit ${PIPESTATUS[0]}
  verify-manually-with-xcframework-iOS:
    runs-on: macos-15
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: build xcframework, then build project and run tests
        run: |
            cd v3-legacy
            ./scripts/getSimulator
            DESTINATION="platform=iOS Simulator,name=$(cat ./iphoneSim),OS=latest"
            xcodebuild -project BranchSDK.xcodeproj -scheme xcframework
            cd SDKIntegrationTestApps/iOSReleaseTest-Manual/
            xcodebuild test -scheme iOSReleaseTest -project iOSReleaseTest.xcodeproj -destination "$DESTINATION" | xcpretty && exit ${PIPESTATUS[0]}
  verify-manually-with-StaticFramework-iOS:
    runs-on: macos-15
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: build static xcframework, then build project and run tests
        run: |
            cd v3-legacy
            ./scripts/getSimulator
            DESTINATION="platform=iOS Simulator,name=$(cat ./iphoneSim),OS=latest"
            xcodebuild -project BranchSDK.xcodeproj -scheme static-xcframework
            cd SDKIntegrationTestApps/iOSReleaseTest-Manual-Static/
            xcodebuild test -scheme iOSReleaseTest -project iOSReleaseTest.xcodeproj -destination "$DESTINATION" | xcpretty && exit ${PIPESTATUS[0]}
  verify-cocoapods-tvOS:
    runs-on: macos-15
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: Install pod, build project and run tests
        run: |
            cd v3-legacy
            ./scripts/getSimulator
            DESTINATION="platform=tvOS Simulator,name=$(cat ./appleTVSim),OS=latest"
            cd SDKIntegrationTestApps/tvOSReleaseTest-Cocoapods/
            pod install
            xcodebuild test -scheme tvOSReleaseTest -workspace tvOSReleaseTest.xcworkspace -destination "$DESTINATION" | xcpretty && exit ${PIPESTATUS[0]}
  verify-carthage-tvOS:
    runs-on: macos-15
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: Skip Carthage test (repo restructuring)
        run: |
            # V3 Legacy Carthage test is skipped due to repo restructuring
            # The root Package.swift (V4 SDK) conflicts with Carthage builds for V3 Legacy
            # V3 Legacy users should use CocoaPods, SPM (v3-legacy/Package.swift), or tagged releases
            echo "Skipping V3 Legacy Carthage tvOS test - repo restructuring broke Carthage compatibility"
            echo "V3 Legacy SDK is still available via: CocoaPods, SPM, Manual xcframework, or tagged releases"
  verify-manually-with-xcframework-tvOS:
    runs-on: macos-15
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: build xcframework, then build project and run tests
        run: |
            cd v3-legacy
            ./scripts/getSimulator
            DESTINATION="platform=tvOS Simulator,name=$(cat ./appleTVSim),OS=latest"
            xcodebuild -project BranchSDK.xcodeproj -scheme xcframework
            cd SDKIntegrationTestApps/tvOSReleaseTest-Manual/
            xcodebuild test -scheme tvOSReleaseTest -project tvOSReleaseTest.xcodeproj -destination "$DESTINATION" | xcpretty && exit ${PIPESTATUS[0]}
