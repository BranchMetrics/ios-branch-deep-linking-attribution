name: iOS Release Build and GPTDriver Tests

on:
  push:
    branches:
      - 'Release-*' # Trigger for branches starting with "Release-"

jobs:
  BuildAndTestAppOnGPTDriver: # Updated job name
    runs-on: macos-latest # macOS runner is required for iOS builds
    steps:
      # --- Step 1: Extract version from branch name ---
      - name: Extract version from branch name
        id: extract_version_step
        run: |
          BRANCH_NAME="${{ github.ref }}"
          # Remove 'refs/heads/' prefix (e.g., refs/heads/Release-0.0.0 -> Release-0.0.0)
          BRANCH_NAME_WITHOUT_PREFIX="${BRANCH_NAME#refs/heads/}"
          # Extract version after "Release-" (e.g., Release-0.0.0 -> 0.0.0)
          VERSION=$(echo "$BRANCH_NAME_WITHOUT_PREFIX" | sed -n 's/^Release-\([0-9]*\.[0-9]*\.[0-9]*\)$/\1/p')

          if [ -z "$VERSION" ]; then
            echo "Error: Could not extract version from branch name '$BRANCH_NAME_WITHOUT_PREFIX'. Expected format: Release-X.Y.Z"
            exit 1
          fi

          echo "Extracted versionName: $VERSION"
          echo "VERSION_STRING=$VERSION" >> $GITHUB_ENV

          # Convert semantic version to an integer for CFBundleVersion (versionCode equivalent)
          # Example: 1.2.3 -> 102003 (assuming max 2 digits for minor/patch)
          # This should be adjusted based on the maximum expected values for major/minor/patch
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)

          # Calculate versionCode (CFBundleVersion) - ensure this fits in a 32-bit integer
          # Standard Android-like conversion: Major * 10000 + Minor * 100 + Patch
          # This provides sufficient uniqueness for most common versioning schemes.
          VERSION_CODE_INT=$(( MAJOR * 10000 + MINOR * 100 + PATCH ))
          echo "Calculated versionCode: $VERSION_CODE_INT"
          echo "VERSION_CODE_INT=$VERSION_CODE_INT" >> $GITHUB_ENV


      # --- Step 2: Checkout the iOS Branch SDK repository ---
      - name: Checkout BranchMetrics/ios-branch-deep-linking-attribution (SDK)
        uses: actions/checkout@v4
        with:
          repository: BranchMetrics/ios-branch-deep-linking-attribution
          ref: ${{ github.ref }} # Use the same branch that triggered the workflow
          path: ./branch-ios-sdk-repo # Checkout into a subdirectory

      # --- Step 3: Build the iOS Branch SDK Framework ---
      - name: Build Branch SDK Framework
        run: |
          echo "--- Listing contents of the SDK repo directory for debugging ---"
          ls -R . # List contents recursively from the current working directory
          echo "-------------------------------------------------------------"
          echo "Attempting to build the SDK framework..."
          xcodebuild build -project BranchSDK.xcodeproj \
            -scheme BranchSDK \
            -configuration Debug \
            -sdk iphonesimulator \
            BUILD_DIR="${{ github.workspace }}/branch-ios-sdk-repo/build" \
            SKIP_INSTALL=NO
        working-directory: ./branch-ios-sdk-repo # Run xcodebuild from the SDK's checkout directory

      # --- Step 4: Checkout the iOS Branch Link Simulator App repository ---
      - name: Checkout BranchMetrics/BranchLinkSimulator (App)
        uses: actions/checkout@v4
        with:
          repository: BranchMetrics/BranchLinkSimulator
          ref: gptdriver/linkingTests # Checkout the specific app branch
          path: ./ios-app-repo # Checkout into another subdirectory

      # --- Step 5: Copy the generated SDK Framework to the App's project ---
      - name: Copy generated SDK Framework to App's project
        run: |
          # Create a 'Frameworks' directory within the app repo for the local SDK
          mkdir -p ./ios-app-repo/Frameworks
          # Copy the built framework
          cp -R ./branch-ios-sdk-repo/build/Debug-iphonesimulator/BranchSDK.framework ./ios-app-repo/Frameworks/
        working-directory: ${{ github.workspace }} # Run from the root of the GITHUB_WORKSPACE

      # --- Step 6: Build the iOS Branch Link Simulator App using the local SDK Framework ---
      - name: Build iOS App with local SDK
        run: |
          # Build the app. Adjust project/workspace, scheme, and destination if necessary.
          # We're passing MARKETING_VERSION (versionName) and CURRENT_PROJECT_VERSION (versionCode)
          xcodebuild build -project BranchLinkSimulator.xcodeproj \
            -scheme BranchLinkSimulator \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            MARKETING_VERSION=${{ env.VERSION_STRING }} \
            CURRENT_PROJECT_VERSION=${{ env.VERSION_CODE_INT }} \
            FRAMEWORK_SEARCH_PATHS="$(SRCROOT)/Frameworks" \
            # You might also need LD_RUNPATH_SEARCH_PATHS if it's an embedded framework
            # LD_RUNPATH_SEARCH_PATHS="@loader_path/../Frameworks"

          echo "--- Listing contents of the app's build output directory for debugging ---"
          # List the contents of the 'build' directory relative to the app's repo root
          ls -R "${{ github.workspace }}/ios-app-repo/build/" || true # '|| true' prevents step from failing if dir doesn't exist
          echo "-------------------------------------------------------------"
        working-directory: ./ios-app-repo # Run xcodebuild from the App's checkout directory

      # --- Step 7: Echo the location of the generated .app bundle ---
      - name: Echo .app bundle location
        run: |
          # Renamed from APK_PATH to APP_PATH for iOS clarity
          APP_PATH="./ios-app-repo/build/Debug-iphonesimulator/BranchLinkSimulator.app"
          echo "Generated .app bundle location: $APP_PATH"

      # --- Step 8: Upload Build Artifacts ---
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: BranchLinkSimulator-iOS-Debug-Build
          # Path uses the new APP_PATH variable if you decide to define it globally,
          # or simply the direct path as shown.
          path: ./ios-app-repo/build/Debug-iphonesimulator/BranchLinkSimulator.app

      # --- Step 9: Upload and run tests on GPTDriver service. ---
      - name: Run GPTDriver tests
        run: |
          # Ensure the script is executable
          chmod +x ./branch-ios-sdk-repo/.github/gptdriverrunscript.sh
          # Execute the script, passing the .app path and platform
          # Uses the APP_PATH variable defined in Step 7
          bash ./branch-ios-sdk-repo/.github/gptdriverrunscript.sh ./ios-app-repo/build/Debug-iphonesimulator/BranchLinkSimulator.app ios
        env:
          API_ORG_KEY: ${{ secrets.MOBILEBOOST_API_ORG_KEY }}
          API_KEY: ${{ secrets.MOBILEBOOST_API_ORG_KEY }}
          TEST_TAGS: Release